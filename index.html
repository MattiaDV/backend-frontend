<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
        <title>WorldChat - official</title>
        <link rel = "stylesheet" href = "style/style.css">
        <link rel="manifest" href="./webapp/site.webmanifest">
    </head>
    <body>

      <div class = "upperPart">WorldChat</div>

  <form id="form">
    <input type="text" value = "Anonimo" name="nickname" placeholder="nickname" required readonly>
    <textarea name="message" placeholder="Inserisci il tuo messaggio" required></textarea>
    <input type="submit" value="Invia">
  </form>

  <div id="chatGene"></div>
  <div class = "space"></div>

  <script type = "module" src = "script/script.js"></script>
  <script src="/socket.io/socket.io.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const chatg = document.getElementById('chatGene');
      const form = document.getElementById('form');

      function aggiungiMessaggio(nickname, messaggio) {
        const html = `
          <div class = "messaggiocompleto">
            <div class="nickname">${nickname}</div>
            <div class="message">${messaggio}</div>
          </div>
        `;
        chatg.innerHTML += html;
        chatg.scrollTop = chatg.scrollHeight;
      }

      fetch('/pages/messages.json')
        .then(res => res.json())
        .then(messages => {
          messages.forEach(m => aggiungiMessaggio(m.nickname, m.messaggio));
        });

      const socket = io();

      socket.on('newMessage', ({ nickname, messaggio }) => {
        aggiungiMessaggio(nickname, messaggio);
      });

      form.addEventListener('submit', async (e) => {
        e.preventDefault();
        const nickname = form.nickname.value;
        const messaggio = form.message.value;

        const res = await fetch('/messaggio', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ nickname, messaggio })
        });

        if (res.ok) {
          form.reset();
        } else {
          alert('Errore nell\'invio del messaggio');
        }
      });
    });
  </script>
</body>
    </body>
</html>